<?php/**  * @Framework Zend Framework * @Powered By TIS  * @category   ERP Product * @copyright  Copyright (c) 2014-2015 Techintegrasolutions Pvt Ltd. * (http://www.techintegrasolutions.com) *	Authors Kannan and Rajkumar */class Application_Model_AddonGradeAllocationItems extends Zend_Db_Table_Abstract{    public $_name = 'addon_grade_allocation_items';    protected $_id = 'grade_allocation_item_id';      //get details by record for edit	public function getRecords($id)    {               $select=$this->_db->select()                      ->from($this->_name)                      ->where("$this->_name.grade_allocation_id=?", $id);				   					  //->where("$this->_name.status !=?", 2);					 // echo $select;die;        $result=$this->getAdapter()                      ->fetchAll($select);       				          return $result;    }	public function getRecordsOnComponentID($id)    {               $select=$this->_db->select()                      ->from($this->_name)                      ->where("$this->_name.component_id=?", $id);				   					  //->where("$this->_name.status !=?", 2);					 // echo $select;die;        $result=$this->getAdapter()                      ->fetchAll($select);            return $result;    }               public function getStudentFailDetailsAll($session,$department,$cmn_terms,$fail_no_subject=0,$student_id = '',$promotion = false){                  $select = empty($student_id)?"select  COUNT(DISTINCT course_id) as fail_in,":"select ";                $select.="temtb.*  from (select erp_student_information.student_id,erp_student_information.stu_fname,erp_student_information.reg_no,erp_student_information.exam_roll,erp_student_information.father_fname                    ,erp_student_information.stu_id,course_type_master.ct_id,course_type_master.ct_name,course_master.course_name,course_master.course_code,grade_allocation_master.course_id,core_course_master.ge_id,core_course_master.count_id,grade_allocation_master.term_id,                    grade_allocation_master.cmn_terms,grade_allocation_items.component_id,grade_allocation_items.grade_value,grade_allocation_items.number_value,obtained_marks obtained_marks,total_marks,percent,                    credit_master.credit_value,                reference_grade_master_items.* from grade_allocation_items                 ,erp_student_information                ,grade_allocation_master                ,core_course_master                ,credit_master                ,reference_grade_master                ,reference_grade_master_items                ,course_master                ,course_type_master                ,academic_master where grade_allocation_items.grade_allocation_id in (SELECT grade_id FROM `grade_allocation_master` WHERE grade_allocation_master.session = $session and cmn_terms in $cmn_terms AND `flag` LIKE 'r')                  and erp_student_information.student_id = grade_allocation_items.student_id                and grade_allocation_master.grade_id = grade_allocation_items.grade_allocation_id                AND core_course_master.academic_year_id = grade_allocation_master.academic_id                And academic_master.academic_year_id = erp_student_information.academic_id                and core_course_master.course_id = grade_allocation_master.course_id                and course_master.course_id = grade_allocation_master.course_id                and academic_master.department = $department                and core_course_master.term_id =  grade_allocation_master.term_id                and core_course_master.credit_id = credit_master.credit_id                and course_type_master.ct_id = course_master.ct_id                and reference_grade_master.session = grade_allocation_master.session                and reference_grade_master_items.reference_id = reference_grade_master.reference_id                and reference_grade_master_items.marks_from <= percent                and reference_grade_master_items.marks_to >= percent";                $select .= !empty($student_id)?" and erp_student_information.student_id = $student_id":"";                                $select .= !$promotion?" ) as temtb where  grade_value REGEXP '(F|NA|Ab|D)'":" ) as temtb where  grade_value NOT REGEXP '(F|NA|Ab|D)'";                                 $select .= empty($student_id)?" group by student_id having COUNT(DISTINCT course_id) >= $fail_no_subject":" group by cmn_terms,course_id";               // echo "<pre>".$select; die;                 $result=$this->getAdapter()                      ->fetchAll($select);              return $result;                    }             public function getStudentMarksDetails($academic_year_id,$addon_id,$ispayment=false,$isAttendance=false,$tabTermId=0,$cmn_terms = ''){        if($cmn_terms=="t1")        return $this->getStudentMarksDetailsWithoutTab($academic_year_id,$terms_ids,$ispayment,$isAttendance,$tabTermId,$cmn_terms );             $sql="";    if($isAttendance){        $sql.="select * from (";    }                $sql.= "select erp_student_information.student_id,erp_student_information.stu_fname,erp_student_information.reg_no,erp_student_information.exam_roll,erp_student_information.father_fname                    ,erp_student_information.stu_id,addon_course_master.course_name,addon_course_master.course_code,addon_grade_allocation_master.course_id,core_addon_master.count_id,addon_grade_allocation_master.term_id,                    addon_grade_allocation_master.cmn_terms,addon_grade_allocation_items.component_id,addon_grade_allocation_items.grade_value,addon_grade_allocation_items.number_value,obtained_marks obtained_marks,total_marks,percent,                    credit_master.credit_value,                addon_reference_grade_items.*";                $sql.=$isAttendance?",semester_wise_attendance_report.course_id attcourse":"";                $sql.=" from addon_grade_allocation_items                 ,erp_student_information                ,addon_grade_allocation_master                ,core_addon_master                ,credit_master                ,addon_reference_grade_master                ,addon_reference_grade_items                ,addon_course_master                ,course_type_master                ,addon_tabulation_report                ,addon_tabulation_report_items";                                                           $sql.=$ispayment?",exam_form_submission":"";            $sql.=$isAttendance?",semester_wise_attendance_report":"";            $sql.=" where addon_grade_allocation_items.grade_allocation_id in (SELECT grade_id FROM `grade_allocation_master` WHERE grade_allocation_master.academic_id in ($academic_year_id) and term_id in ('".implode("','",$terms_ids)."') AND `flag` LIKE 'r')                  and erp_student_information.student_id = addon_grade_allocation_items.student_id                and addon_grade_allocation_master.grade_id = addon_grade_allocation_items.grade_allocation_id                AND core_addon_master.academic_year = addon_grade_allocation_master.academic_year                               and core_addon_master.course_id = addon_grade_allocation_master.course_id                and addon_course_master.course_id = addon_grade_allocation_master.course_id                               and core_addon_master.credit_id = credit_master.credit_id                                and addon_tabulation_report.academic_year = addon_grade_allocation_master.academic_year                and addon_tabulation_report.flag like 'R'                and addon_tabulation_report_items.tabl_id = addon_tabulation_report.tabl_id                and addon_tabulation_report_items.student_id = addon_grade_allocation_items.student_id";                                $sql.=$tabTermId>0?" and tabulation_report.term_id = $tabTermId":" and tabulation_report.term_id = grade_allocation_master.term_id";                $sql.=$tabTermId>0?" and tabulation_report_items.final_remarks like 'p'":"";                                $sql.=$ispayment?" and exam_form_submission.student_id=grade_allocation_items.student_id":"";                $sql.=$ispayment?" and exam_form_submission.term_id=grade_allocation_master.term_id":"";                $sql.=$ispayment?" and exam_form_submission.payment_status=1":"";                                $sql.=$isAttendance?" and semester_wise_attendance_report.u_id = erp_student_information.stu_id":"";                $sql.=$isAttendance?" and semester_wise_attendance_report.cmn_terms = grade_allocation_master.cmn_terms":"";                $sql.=$isAttendance?" and  ((semester_wise_attendance_report.course_id = 0 and academic_master.department = grade_allocation_master.department)                   or   (semester_wise_attendance_report.course_id = grade_allocation_master.course_id and semester_wise_attendance_report.ge_id = grade_allocation_master.ge_id) )":"";                                $sql.=" and addon_reference_grade_master.addon_course_list = addon_grade_allocation_master.addon_course_list                and addon_reference_grade_master.academic_year = addon_grade_allocation_master.academic_year                                and addon_reference_grade_items.reference_id = addon_reference_grade_master.reference_id                and addon_reference_grade_items.marks_from <= percent                and addon_reference_grade_items.marks_to >= percent                order by erp_student_information.exam_roll";                                if($isAttendance){                    $sql.=") as temtbl                    where (temtbl.attcourse = 0 and temtbl.ge_id = 0) or (temtbl.attcourse != 0 and temtbl.ge_id != 0)";                }                echo "<pre>".$sql; die;            $result=$this->getAdapter()                      ->fetchAll($sql);              return $result;        } public function getStudentMarksDetailsWithoutTab($academic_year_id,$addon_id=array(),$ispayment=false,$isAttendance=false,$tabTermId=0,$cmn_terms=''){     $sql="";    if($isAttendance){        $sql.="select * from (";    }                $sql.= "select erp_student_information.student_id,erp_student_information.stu_fname,erp_student_information.reg_no,erp_student_information.exam_roll,erp_student_information.father_fname                    ,erp_student_information.stu_id,addon_course_master.course_name,addon_course_master.course_code,addon_grade_allocation_master.course_id,core_addon_master.count_id,addon_grade_allocation_master.academic_year,                    addon_grade_allocation_master.addon_course_list,addon_grade_allocation_items.component_id,addon_grade_allocation_items.grade_value,addon_grade_allocation_items.number_value,obtained_marks obtained_marks,total_marks,percent,                    credit_master.credit_value,                addon_reference_grade_items.*";                $sql.=$isAttendance?",semester_wise_attendance_report.course_id attcourse":"";                $sql.=" from addon_grade_allocation_items                 ,erp_student_information                ,addon_grade_allocation_master                ,core_addon_master                ,credit_master                ,addon_reference_grade_master                ,addon_reference_grade_items                ,addon_course_master";            $sql.=$ispayment?",exam_form_submission":"";            $sql.=$isAttendance?",semester_wise_attendance_report":"";            $sql.=" where addon_grade_allocation_items.grade_allocation_id in (SELECT grade_id FROM `addon_grade_allocation_master` WHERE addon_grade_allocation_master.academic_year in ($academic_year_id) and addon_course_list in ($addon_id) AND `flag` LIKE 'r')                  and erp_student_information.student_id = addon_grade_allocation_items.student_id                and addon_grade_allocation_master.grade_id = addon_grade_allocation_items.grade_allocation_id                AND core_addon_master.academic_year = addon_grade_allocation_master.academic_year                and core_addon_master.course_id = addon_grade_allocation_master.course_id                and addon_course_master.course_id = addon_grade_allocation_master.course_id                and core_addon_master.addon_course_list =  addon_grade_allocation_master.addon_course_list                and core_addon_master.credit_id = credit_master.credit_id";                              $sql.=$ispayment?" and exam_form_submission.student_id=grade_allocation_items.student_id":"";                $sql.=$ispayment?" and exam_form_submission.term_id=grade_allocation_master.term_id":"";                $sql.=$ispayment?" and exam_form_submission.payment_status=1":"";                                $sql.=$isAttendance?" and semester_wise_attendance_report.u_id = erp_student_information.stu_id":"";                $sql.=$isAttendance?" and semester_wise_attendance_report.cmn_terms = grade_allocation_master.cmn_terms":"";                $sql.=$isAttendance?" and  ((semester_wise_attendance_report.course_id = 0 and semester_wise_attendance_report.department = grade_allocation_master.department)                   or   (semester_wise_attendance_report.course_id = grade_allocation_master.course_id and semester_wise_attendance_report.ge_id = grade_allocation_master.ge_id) )":"";                                $sql.=" and addon_reference_grade_master.addon_course_list = addon_grade_allocation_master.addon_course_list                and addon_reference_grade_master.academic_year = addon_grade_allocation_master.academic_year                                and addon_reference_grade_items.reference_id = addon_reference_grade_master.reference_id                and addon_reference_grade_items.marks_from <= percent                and addon_reference_grade_items.marks_to >= percent                order by erp_student_information.exam_roll,addon_course_master.course_code";                                if($isAttendance){                    $sql.=") as temtbl                    where (temtbl.attcourse = 0 and temtbl.ge_id = 0) or (temtbl.attcourse != 0 and temtbl.ge_id != 0)";                }           //   echo "<pre>".$sql; die;            $result=$this->getAdapter()                      ->fetchAll($sql);              return $result;}public function getArchivedData($academic_year_id,$term_id,$student_id,$course_id,$date){     $sql = "select erp_student_information.student_id,erp_student_information.stu_fname,erp_student_information.reg_no,erp_student_information.exam_roll,erp_student_information.father_fname                    ,erp_student_information.stu_id,course_type_master.ct_name,course_master.course_code,grade_allocation_master.course_id,core_course_master.ge_id,core_course_master.count_id,grade_allocation_master.term_id,                    grade_allocation_master.cmn_terms,grade_allocation_items.grade_value,grade_allocation_items.number_value,obtained_marks obtained_marks,total_marks,percent,                    credit_master.credit_value,                reference_grade_master_items.*                from deleted_grade_allocation_items as grade_allocation_items                 ,erp_student_information                ,grade_allocation_master                ,core_course_master                ,credit_master                ,reference_grade_master                ,reference_grade_master_items                ,course_master                ,course_type_master                 where grade_allocation_items.grade_allocation_id in (SELECT grade_id FROM `grade_allocation_master` WHERE grade_allocation_master.academic_id in ($academic_year_id) and term_id in ($term_id) AND `flag` LIKE 'r')                  and erp_student_information.student_id = grade_allocation_items.student_id                and grade_allocation_master.grade_id = grade_allocation_items.grade_allocation_id                AND core_course_master.academic_year_id = grade_allocation_master.academic_id                and core_course_master.course_id = grade_allocation_master.course_id                and course_master.course_id = grade_allocation_master.course_id                and core_course_master.term_id =  grade_allocation_master.term_id                and core_course_master.credit_id = credit_master.credit_id                and course_type_master.ct_id = course_master.ct_id                and reference_grade_master.degree_id = grade_allocation_master.degree_id                and reference_grade_master.session = grade_allocation_master.session                and reference_grade_master_items.reference_id = reference_grade_master.reference_id                and reference_grade_master_items.marks_from <= percent                and reference_grade_master_items.marks_to >= percent                and grade_allocation_items.student_id = $student_id                and grade_allocation_master.course_id = $course_id                and DATE_FORMAT(grade_allocation_items.publish_date,'%Y-%m-%d') = '$date'                and grade_allocation_master.flag like 'r'                and grade_allocation_items.flag like 'B'                order by grade_allocation_items.grade_allocation_item_id ASC";                        $result=$this->getAdapter()                      ->fetchRow($sql);              return $result;}    public function getCGPAForStudent($acdemic_year_id,$stu_id=""){	$select ="select erp_student_information.student_id,erp_student_information.stu_fname,erp_student_information.reg_no,erp_student_information.exam_roll,erp_student_information.father_fname                    ,erp_student_information.stu_id,grade_allocation_master.degree_id,grade_allocation_master.session,sum(obtained_marks) obtained_marks,sum(total_marks) total_marks,                    format(sum(reference_grade_master_items.number_grade*credit_master.credit_value)/sum(credit_master.credit_value),3)  cgpa                from grade_allocation_items                 ,erp_student_information                ,grade_allocation_master                ,core_course_master                ,credit_master                ,reference_grade_master                ,reference_grade_master_items                ,course_master                ,course_type_master                 ,tabulation_report                ,tabulation_report_items                where grade_allocation_items.grade_allocation_id in (SELECT grade_id FROM `grade_allocation_master` WHERE grade_allocation_master.academic_id in ($acdemic_year_id) and cmn_terms in ('t1','t2','t3','t4','t5','t6') AND `flag` LIKE 'r')                  and erp_student_information.student_id = grade_allocation_items.student_id                and grade_allocation_master.grade_id = grade_allocation_items.grade_allocation_id                AND core_course_master.academic_year_id = grade_allocation_master.academic_id                and core_course_master.course_id = grade_allocation_master.course_id                and course_master.course_id = grade_allocation_master.course_id                and core_course_master.term_id =  grade_allocation_master.term_id                and core_course_master.credit_id = credit_master.credit_id                and course_type_master.ct_id = course_master.ct_id                and tabulation_report.academic_id = grade_allocation_master.academic_id                and tabulation_report.term_id = grade_allocation_master.term_id                and tabulation_report.flag like 'R'                and tabulation_report_items.tabl_id = tabulation_report.tabl_id                and tabulation_report_items.student_id = grade_allocation_items.student_id                and reference_grade_master.degree_id = grade_allocation_master.degree_id                and reference_grade_master.session = grade_allocation_master.session                and reference_grade_master_items.reference_id = reference_grade_master.reference_id                and reference_grade_master_items.marks_from <= percent                and reference_grade_master_items.marks_to >= percent                and core_course_master.count_id = 0";                if(!empty($stu_id))                $select.=" and stu_id = '$stu_id'";                $select.=" GROUP by stu_id                order by erp_student_information.exam_roll,grade_allocation_master.cmn_terms,course_type_master.sort_order,course_type_master.ct_name";              //  echo "<pre>".$select; die;                 $result=$this->getAdapter()                      ->fetchRow($select);              return $result;                }		public function trashItems($grade_allocation_id) {        $this->_db->delete($this->_name, "grade_allocation_id=$grade_allocation_id");    }	    public function saveRows($array) {        $vAmount    = count($array);        $values     = array();        $columns    = array();    if($vAmount>0){        foreach ($array as $colval) {            foreach ($colval as $column=>$value) {                array_push($values,$value);                !in_array($column,$columns) ? array_push($columns,$column) : null;            }        }        $cAmount    = count($columns);        $values     = array_chunk($values, $cAmount);        $iValues    = '';        $iColumns   = implode("`, `", $columns);        for($i=0; $i<$vAmount;$i++)            $iValues.="('".implode("', '", $values[$i])."')".(($i+1)!=$vAmount ? ',' : null);        $data="INSERT INTO `".$this->_name."` (`".$iColumns."`) VALUES ".$iValues;        $this->getAdapter()->query($data);    }}}?>