<?php
$grade_allocation_report_item = new Application_Model_Corecourselearning();
$stu_details = $this->stu_details;

$url = $this->url;
$passmarks = $this->passpercent;

                        $session_name = 'XXXX-XXXXX';
                        if($stu_details['academic_id']){
                        $academic_model = new Application_Model_Academic();
                        $academic_details = $academic_model->getRecord($stu_details['academic_id']);
                        $session_model = new Application_Model_Session(); 
                        $session_name = $session_model->getRecord($academic_details['session'])['session'];
                             $deg_details = new Application_Model_Department();
                            $d_id = $academic_details['department'];
                            $programmDetails = $deg_details->getRecord($d_id);
                            $degree_id = $programmDetails['degree_id'];
                            $programmName = $programmDetails['description'];
                        }
                     
$sl_no = $this->gradesheet_number;
//===============[WIDTHS]
$marks_width = '20px';
$marks_width1 = '20px';
$marks_width4 = '25px';
$marks_width3 = "14px";
$total_width = "10px";
$f_p = array();
?>
<style>
.sup {
   border:.01em solid #932e90;
        text-align: center;
        font-size:.8em;
}
    table{
        margin:0;
    }
    .sub{
        border:.01em solid #932e90;
        text-align: center;
        font-size:.8em;
    }
    .logo{
        display:none;
    }

td.sub{
        border:.01em solid #932e90;
        text-align: center;
        font-size:.8em;
    }
  
</style>



<div class="grade-data-container" style="margin-top:10px;">
    <table class="tablestyle1" width="100%" cellspacing ="0" >
        <thead>
            <tr >
                <!--[COLLEGE HEADER AND LOG STUDENT IMAGE]--->
                <th class="sub" width='<?= $marks_width; ?>' ><img src="<?= $this->mainconfig['publicpath']; ?>/images/img.png"></th>
                <th class="sub" width='<?= $marks_width1; ?>'>
                   <pre style="font-family:'Times New Roman'; background-color: #fff !important;border:1px solid #fff;">
    <span style ="font-size:1.5em; letter-spacing:.03em; font-weight:900">PATNA WOMEN'S COLLEGE</span>
        <span style ="font-size:1.3em; letter-spacing:.05em; font-weight:900">AUTONOMOUS</span>
        <span style ="font-size:1em; font-weight:900">PATNA UNIVERSITY</span>
    3rd&nbsp;Cycle&nbsp;NAAC&nbsp;Accredited&nbsp;<span style="text-transform: lowercase;">at</span>&nbsp;A Grade&nbsp;<span style="text-transform: lowercase;">with</span>&nbsp;CGPA&nbsp;3.58/4
'College&nbsp;<span style="text-transform: lowercase;">&nbsp;with</span>&nbsp;Potential&nbsp;<span style="text-transform: lowercase;">for</span>&nbsp;Excellence'(CPE)&nbsp;<span style="text-transform: lowercase;">status accorded by&nbsp;</span>UGC
           <span style ="font-size:1em; font-weight:900"> BAILEY ROAD,PATNA</span> - 800 001, BIHAR
                    </pre>
                </th>
                <th class="sub" width='<?= $marks_width; ?>'>
                      <?php if (!empty($stu_details['filename'])) { ?>
                                    <img height="150" src="<?= $this->mainconfig['host'] . $stu_details['filename']; ?>">
                                <?php } else { ?>
                                    No image.
                                <?php } ?><br>       
                </th>
            </tr>
            <tr>
                <th class="sub" style="text-align:left;"><small>SL. No: <?=$sl_no;?></small></th>

               <th class="sup">
                      <?= $academic_details['batch_code']; ?>
                </th>

                <th class="sub" style="text-align:center;">
                   
                         <?=$stu_details['stu_id'];?>
                </th>
            </tr>
            <!--            AACADEMIC SESSION AND PRINT OUT DATE-->
            <tr>
			<?php if(!$stu_details['academic_id']){ 
			$col_span = 3;
			$align = 'center';
			}else{
				$col_span = '';
				$align = 'left';
			}
			?>
			
			
                <td class="sub" style='text-align:left;' colspan = "<?=$col_span;?>" ><small>
                    <?php 
                    $academic_model = new Application_Model_Academic();
                    $examDateModel = new Application_Model_ExamDateModel();
					if(!$stu_details['academic_id']){
						echo "Student Report Card Not Pepared !";exit;
					}
                        $academic_details = $academic_model->getRecord($stu_details['academic_id']);
                        //Added By Kedar for Examination Dates
                            $term=!empty($this->cmn_terms)?$this->cmn_terms:'';
                            $session_id=!empty($academic_details['session'])?$academic_details['session']:'';
                            $requiredData= array(
                                'acad_id'=>$academic_details['academic_year_id'],
                                'term'=>$term,
                                'session'=>$session_id,
                                'exam_type'=>2
                            );
                            //echo '<pre>';print_r($requiredData);exit;
                            $examinationDates= $examDateModel->getRecordByAcadId($requiredData);
                        //End Kedar Date : 27 Jan 2021
                       
                    ?>
                      <span style ="font-size:1em; font-weight:900"> SESSION: </span> <?= $session_name; ?>

                    </small>
                </td >
                   <th class="sub"  >  STATEMENT OF MARKS AND GRADE POINTS (CBCS)</th>
              
                <td class="sub" style='text-align:left;'>
                   <small><span style ="font-size:1em; font-weight:900">
                                <?php
                                
                                    $tr_items = new Application_Model_TabulationReportItems();
                                    $trModel = new Application_Model_TabulationReport();
                                    $termMaster= new Application_Model_TermMaster();
                                    $getTermId= $termMaster->getRecordByAcadCmnterms($requiredData);
                                    $tabl_id=$this->student_marks_details[$this->term_marks[0]][0]['tabl_id'];
                                    $NonCollegiate= $tr_items->getRecordByStudentIdForNonCollegiate($this->student_marks_details[$this->term_marks[0]][0]['student_id'],$tabl_id);
                                    $checkRevalDate=$tr_items->getRecordByStudentIdForNonCollegiateReval($this->student_marks_details[$this->term_marks[0]][0]['student_id'],$tabl_id);
                                    // echo '<pre>';print_r($NonCollegiate);exit;
                                    if(!empty($NonCollegiate['NonTblId']) || !empty($checkRevalDate['RevalTblId']))
                                        $tablId=!empty($checkRevalDate['RevalTblId'])?$checkRevalDate['RevalTblId']:$NonCollegiate['NonTblId'];
                                        $followupDate =$checkRevalDate['reval_date'];
                            // echo '<pre>';print_r($tablId);exit;
                                    $cmnTerms = $trModel->getTermIdByTablId($tablId);
                                    //$this->tabldetails['term_id'] .='';
                                    //echo '<pre>';print_r($cmnTerms['term_id']);exit;
                                    $this->tabldetails['term_id'] = $cmnTerms['term_id'];
                                if(!empty($NonCollegiate['NonTblId']) || !empty($checkRevalDate['RevalTblId'])){
                                    $flag='NC';
                                    $revalDates = $examDateModel->getRevalDates($this->tabldetails['term_id'],$followupDate,$flag);
                                    $dtae = Date('d-m-Y', strtotime($examinationDates['result_publish_date']));
                                   //echo '<pre>';print_r($revalDates);exit;

                                    if (!empty($checkRevalDate['RevalTblId'])){
                                        $revalDate = Date('d-m-Y', strtotime($revalDates['reval_date']));
                                        $nonPublishDate = Date('d-m-Y', strtotime($revalDates['result_publish_date']));
                                        
                                        ?>
                                        DATE OF RESULT: </span><?= $nonPublishDate; ?>    <br>
                                        DATE OF RESULT: </span><?= $revalDate; ?> 

                                    <?php
                                    } else {
                                    $nonPublishDate = $dtae;
                                    ?>
                                    DATE OF RESULT: </span><?= $nonPublishDate; ?> 

                                    <?php
                                }
                            } else {
                                //echo '<pre>';print_r($examinationDates);exit;
                                $dtae = Date('d-m-Y', strtotime($examinationDates['result_publish_date']));
                                ?>
                                DATE OF RESULT: </span><?= $dtae; ?> 
                            <?php } ?> 
                        </small>
                    <!---<small><span style ="font-size:1em; font-weight:900">
                   <?php  $reval_date = new Application_Model_Revalstatus();
                                    $added_date = $reval_date->getRecordby($this->student_marks_details[$this->term_marks[0]][0]['tabl_id'],$this->student_marks_details[$this->term_marks[0]][0]['student_id'],'B');
                                    
                                   if(!empty($added_date['added_date'])){
                                       
                            ?>
                            Date:&nbsp; </span><?= $added_date['added_date']; ?> 
                            <?php }else{ ?>
                        Date:&nbsp; </span><?= $this->term_id !=0?Date('d-m-Y',strtotime($this->publish_dates[$this->term_id])):Date('d-m-Y'); ?> 
                        
                        <?php } ?> 
                    </small>--->
                </td>
            </tr>
            <!--            STUDENT PERSONAL DETAILS-->
             <tr>
                <td class="sub" colspan=2 style='text-align:left;'  ><small> <span style ="font-size:1em; font-weight:900">SUBJECT :</span></small> <?=$programmName;?></td>
                <td class="sub" colspan=1 style='text-align:left;'> <small> <span style ="font-size:1em; font-weight:900"><?php if($examinationDates['stu_mark_sheet_status']=='0') { ?> DATE OF ISSUE : <?=Date("d-m-Y");?> <?php } ?></span></small></td>
            </tr>
            <tr>
                <td class="sub" style='text-align:left;' ><small> <span style ="font-size:1em; font-weight:900">STUDENT'S NAME: </span><?= $stu_details['stu_fname'] . ' ' . $stu_details['stu_lname']; ?> </small></td>
                 <td class="sub" ></td>
                <td class="sub" style='text-align:left;' ><small> <span style ="font-size:1em; font-weight:900">EXAMINATION ROLL NO: </span><?= $stu_details['exam_roll']; ?></small> </td>
            </tr>

            <tr>
                <td class="sub" style='text-align:left;' ><small><span style ="font-size:1em; font-weight:900">MOTHER'S NAME: </span><?= $stu_details['mother_fname'] . ' ' . $stu_details['mother_lname']; ?></small></td>
                <th class="sub"  >  
                    <?php if(!$single_pr){ 
                        $term_det = new Application_Model_TermMaster();
                        $term_name = $term_det->getRecord($this->term_marks[0])['term_name'];
                         switch($term_name){
                            case "I":
                              $term_name = "1st Semester";
                                  break;
                                    case "II":
                              $term_name = "2nd Semester";
                                  break;
                                    case "III":
                              $term_name = "3rd Semester";
                                  break;
                                    case "IV":
                              $term_name = "4th Semester";
                                  break;
                                    case "V":
                              $term_name = "5th Semester";
                                  break;
                                    case "VI":
                              $term_name = "6th Semester";
                                  break;
                                  default:
                                     $term_name = $term_name; 
                            
                        }
                        echo $term_name;
                        
                        ?>(Examination  <?= !empty($examinationDates['exam_date']) ? date("F",strtotime($examinationDates['exam_date'])).' '.date("Y",strtotime($examinationDates['exam_date'])): 'N/A'  ?>)
                    
                    <?php } ?>
                </th>
                <td class="sub" style='text-align:left;'><small><span style ="font-size:1em; font-weight:900">REGISTRATION NO:</span> <?= $stu_details['reg_no']; ?></small></td>
            </tr>
            <tr ><td class="sub" style='text-align:left;' colspan="3"><small><span style ="font-size:1em; font-weight:900">FATHER'S NAME:</span> <?= $stu_details['father_fname'] . ' ' . $stu_details['father_lname']; ?></small></td></tr>
        </thead>
        <tbody>
            
           
            <!-----------[Important Variables]-------------->
              <?php  
              //==========================[term_iteration_starts]===========//
              $grand_total = $grand_ob_total = $grand_cr_total = $grand_gr_total = $grand_crp_total = 0;
              $gr_pr = 1;
              foreach($this->term_marks as $term_index => $term_id){
                  
                  //====chnage according to term id iterate====//
                    $term_pr_id = $term_id;
                    $stu_marks = $this->student_marks_details[$term_pr_id];
                  //  $sgpa = $this->stu_sgpa[$term_pr_id];
                    $prom = $this->prom;
                 $details_Arr = array($this->term_marks,
                    $this->stu_term_details,
                    $this->stu_academic_details,
                    $this->student_marks_details,
                    $this->stu_course);    
                $sgpa_fail_course_details = getSgpa($details_Arr, $degree_id);
                $sgpa = $sgpa_fail_course_details['sgpa'];

                $fail_ct_id = $sgpa_fail_course_details['fail_in'];
                   // $fail_ct_id = $this->stu_fail_in[$term_pr_id];
                    $term_details = $this->stu_term_details[$term_pr_id];
                    $academic_details = $this->stu_academic_details[$term_pr_id];
                 //   echo "<pre>";print_r($academic_details);exit;
                    $header_component = $this->header_component[$term_pr_id];
                    $session_details = new Application_Model_Session();
                    $session_name = $session_details->getRecord($academic_details['session'])['session'];
                    $ct_ids = $this->stu_course[$term_pr_id];
                    //=============[Spans]
                    $core_span = $this->corespan[$term_pr_id];
                    
                    $course_des_span = count($stu_marks); 
                    $grand_name  = 'GRAND TOTAL';
                    $single_pr = $this->single;
              ?>
            
            <!-----------------[END]---------------------->
            <tr>
                <td colspan="3">
                    <table class="tablestyle1" width="100%" cellspacing="0" id='marks'>
                        <thead>
                            <tr>
                                <th class="sub" rowspan ="2" width="<?= $marks_width; ?>" >Group</th>
                                <th class="sub" rowspan="2" width="<?= $marks_width; ?>">Code</th>
                                <?php foreach ($header_component as $component_key => $compo_val) { ?>
                                    <th class="sub"  colspan="2" width ="<?= $marks_width; ?>"><?= $compo_val['component_name']; ?></th>
                                <?php } ?>
                                <th class="sub" width ="<?= $marks_width; ?>" rowspan="2" >Total</th>
                                <th class="sub" width ="<?= $marks_width; ?>" rowspan="2">Total Marks Obtained</th>
                                <th class="sub" width ="<?= $marks_width; ?>" rowspan="2" >Credit</th>
                                <th class="sub" width ="<?= $marks_width; ?>" rowspan="2" >Grade Letter</th>
                                <th class="sub" width ="<?= $marks_width; ?>" rowspan="2" >Grade Point</th>
                                <th class="sub" width ="<?= $marks_width; ?>" rowspan="2" >Credit Point<br/>(Credit x Grade Point)</th>
                                <th class="sub" width ="<?= $marks_width; ?>" rowspan="2" >SGPA<br/>(Credit Point/ Credit)</th>
                                <th class="sub" width ="<?= $marks_width; ?>" rowspan="2" >Remarks</th>
                                <?php if($single_pr){ ?>
                                <th class="sub" width ="<?= $marks_width; ?>" rowspan="2" >Final Remarks / Fail <span style="text-transform: lowercase;">in</span></th>
                                <?php } ?>
                            </tr>
                            <tr>
                                <?php foreach ($header_component as $component_key => $compo_val) { ?>
                                    <th class="sub" width ="<?= $marks_width; ?>">Full Marks/ Pass Marks</th>
                                    <th class="sub" width ="<?= $marks_width; ?>">Marks Obtained</th>
                                <?php } ?>
                            </tr>
                            <!--------if more than one term-------------->
                            <?php if(!$single_pr){ 
                                $grand_name = 'TOTAL';
                                ?>
                                <tr>
                                    
                                    <th class='sub' width="<?= $marks_width; ?>"><?=$term_details['term_name'];?></th>
                                </tr>
                            <?php }?>
                                
                        </thead>
                        <tbody> 
                            <?php
                            $row_span_arr = array();
                            $promo_one = $sgpa_one = $course_group_arr = array();
                            $empty_cell_prin_len = count($header_component);
                            $all_total = $ob_total = $cr_total = $gr_total = $crp_total = 0;
                            $sgpa_span = $this->sgpaspan[$term_details['term_id']]['sgpa_span'];
                            $tem_percent = 0;
                            $j = 1;
                            ?>
                            <?php
                            
                            foreach ($stu_marks as $marks_key => $marks_val) {
                                //====[student marks sheet details]============//
                                $component_weightages = explode(',', $marks_val['component_weightages']);
                                $component_grades = explode(',', $marks_val['component_grades']);
                                $marks_obtained = explode(',', $marks_val['number_value']);
                                $grade_value = explode(',', $marks_val['grade_value']);
                               
                                 $core_course_master = new Application_Model_Corecourselearning();
                                 $course_credit_info = $core_course_master->getCoreCouseDetailByTermAcademicCourse($academic_details['academic_year_id'], $term_details['term_id'], $marks_val['course_id']);
                                 if($course_credit_info['count_id'] == 0){
                               ?>
                                <?php
                            
                                foreach ($ct_ids as $key => $ct_values) {

                                    $i = 1;
                                    $total = $tot_obtained = $tot_marks = 0;
                                    $pass_fail = 'P';
                                    ?>

                                    <?php
                                    foreach ($ct_values as $ct_keys => $ct_value) {
                                      
                                        if ($marks_val['course_id'] == $ct_value['course_id']) {
                                            $row_span_arr[$key] += 1;
                                            ?>
                                            <tr>
                                                <!--
                                                PRint Only one Course Group-->
                                                <?php if (!in_array($key, $course_group_arr)) {
                                                    $course_group_arr[] = $key;
                                                    ?>
                                                    <td class="sub" rowspan="<?=count($ct_values) ?>" style='text-align:left;' > <?= $key; ?></td><?php } ?>

                                                <!--print Course Code-->
                                                <?php
                                                $courseMaster = new Application_Model_Course();
                                                $course_code = $courseMaster->getRecord($ct_value['course_id'])['course_code'];
                                                ?>
                                                <td class="sub" style='text-align:left;' ><?= $course_code; ?></td>
                                                <!------print total component and number obtained------>
                                                <?php for ($k = 0; $k < count($component_grades); $k++) { ?>
                                                    <?php
                                                    $tot_marks += $component_weightages[$k];
                                                    $tot_obtained += !empty($marks_obtained[$k]) ? $marks_obtained[$k] : 0;
                                                    if($tem_percent == 0)
                                                    $tem_percent = $passmarks;
                                                    
                                                    $passmarks = $tem_percent;
                                                    
                                                      if ($component_weightages[$k] == 250)
                                                                    $passmarks = 50;
                                                                else if ($ct_value['course_id'] == 721)
                                                                    $passmarks = 50;
                                                    ?>
                                                    <td class="sub" ><?= $component_weightages[$k]==0?'--':$component_weightages[$k].' / '.((int)$passmarks/100)*(int)$component_weightages[$k]; ?></td>
                                                   <?php if(!empty($grade_value[$k])){ ?>
                                                    <td class="sub" style ='<?php if(strtolower($grade_value[$k])=="ab" || strtolower($grade_value[$k])=="na" )echo "color:red;";?>'><?php 
                                                    if((!empty($marks_obtained[$k]) || $marks_obtained[$k]==0) && $grade_value[$k]!=='Ab' && $grade_value[$k]!=='NA'){
                                                      echo  $marks_obtained[$k];
                                                      if($grade_value[$k] == 'F'  || $grade_value[$k] == 'D'){
                                                      $pass_fail = 'F';
                                                      $f_p[] ='F'; 
                                                           echo "*";
                                                      }
                                                    }
                                                    else{
                                                       echo $grade_value[$k];
                                                       $pass_fail = 'F';
                                                       $f_p[] ='F'; 
                                                    }
                                                    ?>
                                                    </td>
                                                   <?php } else { ?>
                                                    <td class="sub">--</td>
                                                   <?php } ?>

                                                    <?php
                                                    $i += 1;
                                                }
                                                ?>
                                                <!-- //================[print empty cell]==============//-->

                                                <?php
                                                if ($i < ($empty_cell_prin_len + 1)) {
                                                    for ($pr = $i; $pr <= $empty_cell_prin_len; $pr++) {
                                                        ?>
                                                        <td class="sub" >-- </td>
                                                        <td class="sub" >-- </td>
                                                        <?php
                                                    }
                                                }
                                                ?>


                                                <!-------print total marks or total marks obtained----->         
                                                <td class="sub" width ="<?= $total_width; ?>"><?= $tot_marks; ?></td>

                                                <?php
                                                $all_total += $tot_marks;
                                                $ob_total += $tot_obtained;
                                                ?>
                                                <td class="sub" width ="<?= $marks_width; ?>"><?= $tot_obtained; ?><?php if($pass_fail=='F'){echo '*';}?></td>

                                              

                                                <td class="sub" width ="<?= $marks_width; ?>"><?= $course_credit_info['count_id'] == 0 ? $course_credit_info['credit_value'] : 00; ?>  </td>


                                                <?php $cr_total += $course_credit_info['count_id'] == 0 ? $course_credit_info['credit_value'] : 0; ?> 


                                                <?php
                                                $num = round(((int) $tot_obtained / $tot_marks) * 100);
                                                $ref_grade_item = new Application_Model_ReferenceGradeMasterItems();
                                                $letter_grade = $ref_grade_item->getRecordByNumGrade($num,$degree_id,$academic_details['session']);
                                                if($pass_fail=='F'){$letter_grade = "F";}
                                                ?>
                                                
                                                <td  class="sub" width ="<?= $marks_width; ?>"><?= !empty($letter_grade) ? $letter_grade : '--'; ?></td>

                                                <?php
                                                if (!is_numeric($letter_grade)) {

                                                    $ReferenceGradeMaster_model = new Application_Model_ReferenceGradeMaster();
                                                    $letter_grade_result = $ReferenceGradeMaster_model->getNumberGradeValue(0, $letter_grade,$degree_id,$academic_details['session']);
                                                    $numeric_grade = $letter_grade_result['number_grade'];
                                                } else if (is_numeric($letter_grade)) {
                                                    $numeric_grade = $letter_grade;
                                                } $total = $course_credit_info['count_id'] == 0 ? $numeric_grade * $course_credit_info['credit_value'] : 0;
                                                ?>

                                               <td class="sub" width ="<?= $marks_width; ?>"><?= $numeric_grade==0?"--":$numeric_grade; ?></td>
                                                <td class="sub" width ="10px"><?= $total==0?"--":$total; ?></td>

                                                <?php if (!in_array($sgpa, $sgpa_one)) {
                                                    $sgpa_one[] = $sgpa;
                                                    ?>

                                                    <td  class="sub" width ="<?= $marks_width; ?>" rowspan="<?= $sgpa_span; ?>">
                                                        <?php
                                                            $totalcourse = $grade_allocation_report_item->getRecordsByTermId($term_pr_id);
                                                            if($totalcourse == $sgpa_span && count($f_p)==0){
                                                                echo $sgpa;
                                                            }
                                                            else
                                                            {
                                                                echo "--";
                                                            }
                                                            
                                                        ?>
                                                    </td>
                <?php } ?>

                                                <td class="sub" width ="<?= $marks_width; ?>"><?= $letter_grade == 'F' ? 'F*' : $pass_fail == 'F'?'F*':'P'; ?></td>
                                                <?php if(!in_array($prom,$promo_one) && $single_pr ){
                                                        $promo_one[] = $prom;
                                                   
                                                        $cour_det = new Application_Model_Course();
                                                        $fail_cts = $cour_det->getctname($fail_ct_id,$stu_details['student_id'],$term_pr_id);   
                                                       if(!empty($fail_ct_id)){
                                                      ?>    
                                                <td class="sub" rowspan="<?= $sgpa_span; ?>"><?="$prom <br/>$fail_ct_id";?></td>
                                                       <?php }else{?>
                                                <td class="sub" rowspan="<?= $sgpa_span; ?>"><?="$prom";?></td>
                                                <?php } }?>
                                                <?php
                                                $gr_total += $numeric_grade;
                                                $crp_total += $total;
                                                ?>
                                            </tr>
                                        <?php } ?>
                                    <?php } ?>

                                <?php } ?>
                                <?php
                                 }
                                $j++;
                            }
                            ?>
                            <tr></tr>
                            <!-----------Total or Grand Total --------------------->
                            <tr>
                                <th class="sub" style='text-align:left;' ><?=$grand_name;?></th>
                                <th class="sub" colspan ="<?= ($empty_cell_prin_len * 2) + 1; ?>"></th>
                                <th class="sub"  ><?= $all_total; ?></th>
                                <th class="sub" ><?= count($f_p)==0?$ob_total:'--'; ?></th>
                                <th class="sub"><?= $cr_total; ?></th>
                                <th class="sub"></th>
                                <th class="sub" ></th>
                                <th class="sub" ><?= count($f_p)==0? $crp_total:'--'; ?></th>
                                <th class="sub"></th>
                                <th class="sub"></th>
                                 <?php if($single_pr){ ?>
                                <th class="sub"></th>
                                 <?php } ?>
                            </tr>
                            
                            
                            
                            
                            <!------[For Non countable Values]-------------------->
                            
                             <?php
                            foreach ($stu_marks as $marks_key => $marks_val) {
                                //====[student marks sheet details]============//
                                $component_weightages = explode(',', $marks_val['component_weightages']);
                                $component_grades = explode(',', $marks_val['component_grades']);
                                $marks_obtained = explode(',', $marks_val['number_value']);
                                $grade_value = explode(',', $marks_val['grade_value']);
                               
                                 $core_course_master = new Application_Model_Corecourselearning();
                                 $course_credit_info = $core_course_master->getCoreCouseDetailByTermAcademicCourse($academic_details['academic_year_id'], $term_details['term_id'], $marks_val['course_id']);
                                 if($course_credit_info['count_id'] == 1){
                               ?>
                                <?php
                                foreach ($ct_ids as $key => $ct_values) {

                                    $i = 1;
                                    $total = $tot_obtained = $tot_marks = 0;
                                    $pass_fail = 'P';
                                    ?>

                                    <?php
                                    foreach ($ct_values as $ct_keys => $ct_value) {
                                      
                                        if ($marks_val['course_id'] == $ct_value['course_id']) {
                                            $row_span_arr[$key] += 1;
                                            ?>
                                            <tr>
                                                <!--
                                                PRint Only one Course Group-->
                                                <?php if (!in_array($key, $course_group_arr)) {
                                                    $course_group_arr[] = $key;
                                                    ?>
                                                    <td class="sub" rowspan="<?=count($ct_values) ?>" style='text-align:left;' > <?= $key; ?></td><?php } ?>

                                                <!--print Course Code-->

                                                <?php
                                                $courseMaster = new Application_Model_Course();
                                                $course_code = $courseMaster->getRecord($ct_value['course_id'])['course_code'];
                                                ?>
                                                <td class="sub" style='text-align:left;' ><?= $course_code; ?></td>


                                                <!------print total component and number obtained------>

                                                <?php for ($k = 0; $k < count($component_grades); $k++) { ?>
                                                    <?php
                                                    $tot_marks += $component_weightages[$k];
                                                    $tot_obtained += !empty($marks_obtained[$k]) ? $marks_obtained[$k] : 0;
                                                    if($tem_percent == 0)
                                                    $tem_percent = $passmarks;
                                                    
                                                    $passmarks = $tem_percent;
                                                     if($component_weightages[$k]==250)
                                                        $passmarks = 50;
                                                    ?>
                                                    <td class="sub" ><?= $component_weightages[$k]==0?'--':$component_weightages[$k].' / '.((int)$passmarks/100)*(int)$component_weightages[$k]; ?></td>
                                                   <?php if(!empty($grade_value[$k])){ ?>
                                                    <td class="sub" style ='<?php if(strtolower($grade_value[$k])=="ab" || strtolower($grade_value[$k])=="na" )echo "color:red;";?>'><?php 
                                                    if((!empty($marks_obtained[$k]) || $marks_obtained[$k]==0) && $grade_value[$k]!=='Ab' && $grade_value[$k]!=='NA'){
                                                      echo  $marks_obtained[$k];
                                                         if($grade_value[$k] == 'F'  || $grade_value[$k] == 'D'){
                                                      $pass_fail = 'F';
                                                              echo "*";
                                                         }
                                                      
                                                    }
                                                    else{
                                                       echo $grade_value[$k];
                                                       $pass_fail = 'F';
                                                    }
                                                    ?>
                                                    </td>
                                                   <?php } else { ?>
                                                    <td class="sub">--</td>
                                                   <?php } ?>

                                                    <?php
                                                    $i += 1;
                                                }
                                                ?>
                                                <!-- //================[print empty cell]==============//-->

                                                <?php
                                                if ($i < ($empty_cell_prin_len + 1)) {
                                                    for ($pr = $i; $pr <= $empty_cell_prin_len; $pr++) {
                                                        ?>
                                                        <td class="sub" >-- </td>
                                                        <td class="sub" >-- </td>
                                                        <?php
                                                    }
                                                }
                                                ?>


                                                <!-------print total marks or total marks obtained----->         
                                                <td class="sub" width ="<?= $total_width; ?>"><?= $tot_marks; ?></td>

                                                <td class="sub" width ="<?= $marks_width; ?>"><?= $tot_obtained; ?><?php if($pass_fail=='F'){echo '*';}?></td>
                                                <td class="sub" width ="<?= $marks_width; ?>"><?=$course_credit_info['credit_value'] ; ?>  </td>


                                                <?php
                                                $num = round(((int) $tot_obtained / $tot_marks) * 100);
                                                $ref_grade_item = new Application_Model_ReferenceGradeMasterItems();
                                                $letter_grade = $ref_grade_item->getRecordByNumGrade($num,$degree_id,$academic_details['session']);
                                                ?>
                                                
                                                <td  class="sub" width ="<?= $marks_width; ?>"><?='--'; ?></td>

                                                <?php
                                                if (!is_numeric($letter_grade)) {

                                                    $ReferenceGradeMaster_model = new Application_Model_ReferenceGradeMaster();
                                                   $letter_grade_result = $ReferenceGradeMaster_model->getNumberGradeValue(0, $letter_grade,$degree_id,$academic_details['session']);
                                                    $numeric_grade = $letter_grade_result['number_grade'];
                                                } else if (is_numeric($letter_grade)) {
                                                    $numeric_grade = $letter_grade;
                                                } 
                                                ?>

                                                <td class="sub" width ="<?= $marks_width; ?>"><?= '--'; ?></td>
                                                <td class="sub" width ="10px"><?='--'; ?></td>
                                                    <td  class="sub" width ="<?= $marks_width; ?>" >
                                                    </td>
                                                <td class="sub" width ="<?= $marks_width; ?>"><?= $letter_grade == 'F' ? 'F*' : $pass_fail == 'F'?'F*':'P'; ?></td>
                                                <?php if($single_pr) { ?>
                                               <td class="sub" width ="<?= $marks_width; ?>"></td>
                                                <?php } ?>
                                                <?php
                                                ?>
                                            </tr>
                                        <?php } ?>
                                    <?php } ?>

                                <?php } ?>
                                <?php
                                 }
                                $j++;
                            }
                            ?>
                            
                            
                            
                            
                            
                            <!-------this will print only for single term in ug------------------->
                            <?php if($single_pr) { ?>
                            <!---YET TO PRINT-->
                            <tr>
                                <th class="sub"  style='text-align:left;' >Abbreviation Codes:</th>
                                <th class="sub"  colspan ="<?= ($empty_cell_prin_len * 2) + 6; ?>"></th>
                                <th class="sub"  colspan ="3" style='text-align:left;' >*To Reappear in Concerned semester. </th>
                                <?php if($single_pr) { ?>
                                <th class="sub"></th>
                                <?php } ?>
                            </tr>

 <tr>
                                        <?php  
                                        $department = new Application_Model_Department();
                                         $department_details = $department->getRecord($academic_details['department']);
                                        ?>
                                        <th class="sub" style='text-align:left;'>Programme :</th>
                                       <th class="sub" style='text-align:left;' colspan ="<?= ($empty_cell_prin_len * 2) + 10; ?>"><?=$department_details['description'];?></th>
                                    </tr>

                            <?php
                            $sppear_semester = $course_des = 0;
                            $check_course_id= array();
                           // echo "<pre>";print_r($stu_marks);exit;
                            $na_inc = 0;
                            foreach ($stu_marks as $key => $value) {
                                $courseMaster = new Application_Model_Course();
                               $course_details['course_code'] = '';
                               $course_details['course_name'] = '';
                               $course_details1['course_code'] = '';
                               $course_details1['course_name'] = '';
                                if(!in_array($value['course_id'], $check_course_id) ){
                                    if(!empty($stu_marks[$key]['course_id']))
                                     $course_details = $courseMaster->getRecord($stu_marks[$key]['course_id']);
                                    if(!empty($stu_marks[$key+1]['course_id']))
                                     $course_details1 = $courseMaster->getRecord($stu_marks[$key+1]['course_id']);
                                ?>
                                <tr>
                                    <th class="sub"  style='text-align:left;'   colspan ="<?= ($empty_cell_prin_len * 2); ?>"> <?=!empty($course_details['course_code'])?"{$course_details['course_code']} : ":'';echo $course_details['course_name']; ?></th>
                                    <th class='sub' style='text-align:left;' colspan ="<?= ($empty_cell_prin_len * 2)+1 ; ?>"><?=!empty($course_details1['course_code'])?"{$course_details1['course_code']} : ":''; echo $course_details1['course_name']; ?></th>
                                    <?php if($na_inc ==0) {?>
                                    <td class="sub" colspan="3"></td>
                                    <th class="sub">NA = Not Allowed</th>
                                    
                                    <?php $na_inc++;}else{ ?>
                                    <td class="sub" colspan="4"></td>
                                    <?php } ?>
                                </tr>
                            <?php $check_course_id[$key] = $value['course_id'];
                            $check_course_id[$key+1] = $stu_marks[$key+1]['course_id'];
                            
                            } 
                            
                            } ?>
                            <tr>
                                <th class="sub">GRADE LETTER:</th> 
                                
                                <?php $grades = $ref_grade_item->getRecordByDegId($degree_id,$academic_details['session']); 
                                foreach($grades as $grade_key => $grade_val){
                                    if($grade_val['letter_grade'] != 'NA'){
                                ?>
                                <td class="sub"><?="{$grade_val['letter_grade']} = {$grade_val['des']}";?></td> 
                                
                                <?php }} ?>
                                <th class="sub" colspan="<?=(count($grades)-1)>8?7-((count($grades)-1)-8):(count($grades)-1)<8?7+(8-(count($grades)-1)):7;?>"></th>
                                <th class="sub"></th>
                            </tr>
                            
                            <?php } else{ ?>
                                  <?php 
                            //===============[Grand Total for al the semeseter]======//
                            $grand_total+=$all_total;
                            $grand_ob_total+=$ob_total;
                            $grand_cr_total+=$cr_total;
                            $grand_gr_total+=$gr_total;
                            $grand_crp_total+=$crp_total;
                            
                            $percent = ($grand_ob_total/$grand_total)*100;
                            $ref_grade_item = new Application_Model_ReferenceGradeMasterItems();
                            $letter_grade = $ref_grade_item->getRecordByNumGrade($percent,$degree_id,$academic_details['session']);
                            
                            $cgpa = $grand_crp_total/$grand_cr_total;
                    ?>
                                <?php if(count($this->term_marks)==$gr_pr){?>
                                <tr>    
                  
                                    <th class="sub" style='text-align:left;'><?='GRAND TOTAL';?></th>
                                        <th class="sub" colspan ="<?= ($empty_cell_prin_len * 2) + 1; ?>"></th>
                                        <th class="sub"  ><?= $grand_total; ?></th>
                                        <th class="sub" ><?= $grand_ob_total; ?></th>
                                        <th class="sub"><?= $grand_cr_total; ?></th>
                                        <th class="sub"></th>
                                        <th class="sub" ><?= $grand_gr_total; ?></th>
                                        <th class="sub" ><?= $grand_crp_total; ?></th>
                                        <th class="sub"></th>
                                        <th class="sub"></th>
                            </tr>
                            <tr></tr>
                            <tr>
                                <th class="sub" style='text-align:left;' >Total Grades</th>
                                <th class="sub" colspan ="<?= ($empty_cell_prin_len * 2) + 1; ?>"></th>
                                <th class="sub" style='text-align:left;' >Total Full Marks : <?= $grand_total; ?></th>
                                <th class="sub" style='text-align:left;' >Obtained Marks : <?= $grand_ob_total; ?></th>
                                <th class="sub" style='text-align:left;' >% of Marks : <?= number_format($percent,2) ?></th>
                                <th class="sub" style='text-align:left;' >Final Grade : <?= $letter_grade ?></th>
                                <th class="sub" colspan="2"></th>
                                <th class="sub" style='text-align:left;' >*CGPA : <?= number_format($cgpa,2); ?></th>
                                <th class="sub"></th>
                                
                                
                                
                            </tr>
                            
                                
                           <?php 
                                }
                            } //========[End if for single term]===========// ?>
                        </tbody>

                    </table>
                </td>
            </tr>
            
              <?php $gr_pr++; } //================[Term iteration ends]=============//?>
            
            
            
            <?php if($single_pr) { ?>
            <tr>
                <th class="sub">CIA : Continous Internal Assessment</th>
                <th class="sub">SGPA: Semester Grade Point Average</th>
                <th class="sub"></th>
            </tr>

            <tr>
                <th class="sub"  colspan="2">
                    **Disclaimer: If any discrepancy is cropped up inadvertently due to software then contact examination cell PWC for rectification
                </th>
                <th class="sub"></th>
            </tr>
            <tr>
               <th class="sub" colspan=2><img src="<?php echo $this->mainconfig['publicpath']; ?>images/controler.jpg" alt="..." height="50" width="200"  ></th>
                                                    <th class="sub"><img src="<?php echo $this->mainconfig['publicpath']; ?>images/principal.jpg" alt="..." height="40" width="200" ></th>
            </tr>
            <tr>
                <th class="sub" colspan="2">Controller of Examinations</th>
                <th class="sub">Principal</th>
            </tr>
            <?php } else { ?>
            <tr>
                <th  colspan="3"></th>
                
            </tr>
            <tr>
                 <th class="sub"><img src="<?php echo $this->mainconfig['publicpath']; ?>images/controler.jpg" alt="..." ></th>
                <th class="sub"><img src="<?php echo $this->mainconfig['publicpath']; ?>images/principal.jpg" alt="..." ></th>
                <th class="sub"><img src="https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=<?=$url;?>%2F&choe=UTF-8" title="Link to student Grade Sheet" /></th>
            </tr>
            <tr>
                <th class="sub">Controller of Examinations</th>
                <th class="sub">Principal</th>
                <th class="sub">Qr Code</th>
            </tr>
            <tr>
                <th class="sub" colspan="3"></th>
            </tr>
            <?php } ?>
        </tbody>


    </table>
</div>
<div class="container" width="100%" style="text-align:center; margin-top:.3em">
    <button class="btn btn-primary"  id="print_marks" >Print</button>
</div>
</center>
</body>
<script>
    var button = document.querySelector("#print_marks");
button.addEventListener('click',()=>{

    window.print();
})
</script>
</html>
<?php
function getSgpa($details_arr, $degree_id) {
    $term_marks = $details_arr[0];
    $fail_courses = array();
    foreach ($term_marks as $term_index => $term_id) {
        $term_pr_id = $term_id;
        $term_details = $details_arr[1][$term_pr_id];
        $academic_details = $details_arr[2][$term_pr_id];
        $stu_marks = $details_arr[3][$term_pr_id];
        $ct_ids = $details_arr[4][$term_pr_id];
        $row_span_arr = array();

        $promo_one = $sgpa_one = $term_one = $course_group_arr = array();
        $all_total = $ob_total = $cr_total = $gr_total = $crp_total = 0;
        $tem_percent = 0;
        $fcourse_code = array();
        $j = 1;
        $sgpadynamic = 0;

        foreach ($stu_marks as $marks_key => $marks_val) {
            $component_weightages = explode(',', $marks_val['component_weightages']);
            $component_grades = explode(',', $marks_val['component_grades']);
            $marks_obtained = explode(',', $marks_val['number_value']);
            $grade_value = explode(',', $marks_val['grade_value']);

            $core_course_master = new Application_Model_Corecourselearning();
            $course_credit_info = $core_course_master->getCoreCouseDetailByTermAcademicCourse($academic_details['academic_year_id'], $term_details['term_id'], $marks_val['course_id']);



            foreach ($ct_ids as $key => $ct_values) {
                $i = 1;
                $total = $tot_obtained = $tot_marks = 0;
                $pass_fail = 'P';
                foreach ($ct_values as $ct_keys => $ct_value) {

                    if ($marks_val['course_id'] == $ct_value['course_id']) {
                        $row_span_arr[$key] += 1;
                        $courseMaster = new Application_Model_Course();
                        $course_code = $courseMaster->getRecord($ct_value['course_id'])['course_code'];

                        for ($k = 0; $k < count($component_grades); $k++) {

                            $tot_marks += $component_weightages[$k];
                            $tot_obtained += !empty($marks_obtained[$k]) ? $marks_obtained[$k] : 0;
                            if ($tem_percent == 0)
                                $tem_percent = $passmarks;

                            $passmarks = $tem_percent;

                            if ($component_weightages[$k] == 250)
                                $passmarks = 50;

                            if (!empty($grade_value[$k])) {

                                if ((!empty($marks_obtained[$k]) || $marks_obtained[$k] == 0) && $grade_value[$k] !== 'Ab' && $grade_value[$k] !== 'NA') {

                                    if ($grade_value[$k] == 'F' || $grade_value[$k] == 'D') {
                                        $pass_fail = 'F';

                                        $sgpa = 0;
                                        $fcourse_code[] = $course_code;
                                    }
                                } else {
                                    $fcourse_code[] = $course_code;
                                    $pass_fail = 'F';
                                    $sgpa = 0;
                                }
                            }


                            $i += 1;
                        }
                        $all_total += $tot_marks;
                        $ob_total += $tot_obtained;


                        if ($course_credit_info['count_id'] == 0) {
                            $cr_total += $course_credit_info['count_id'] == 0 ? $course_credit_info['credit_value'] : 0;
                        }


                        $num = round(((int) $tot_obtained / $tot_marks) * 100);
                        $ref_grade_item = new Application_Model_ReferenceGradeMasterItems();
                        $letter_grade = $ref_grade_item->getRecordByNumGrade($num, $degree_id, $academic_details['session']);
                        if ($pass_fail == 'F') {
                            $letter_grade = 'F';
                        }




                        if (!is_numeric($letter_grade)) {

                            $ReferenceGradeMaster_model = new Application_Model_ReferenceGradeMaster();
                            $letter_grade_result = $ReferenceGradeMaster_model->getNumberGradeValue(0, $letter_grade, $degree_id, $academic_details['session']);
                            $numeric_grade = $letter_grade_result['number_grade'];
                        } else if (is_numeric($letter_grade)) {
                            $numeric_grade = $letter_grade;
                        }
                        if ($course_credit_info['count_id'] == 0) {
                            $total = $course_credit_info['count_id'] == 0 ? $numeric_grade * $course_credit_info['credit_value'] : 0;
                            $crp_total += $total;
                        }
                        $sgpadynamic = number_format($crp_total / $cr_total, 2);
                    }
                }
            }
        }
        $fail_courses = implode('/', array_unique($fcourse_code));
        $sgpadynamic = !empty(trim($fail_courses)) ? 0 : $sgpadynamic;
        $j++;
    }
    return array("sgpa" => $sgpadynamic, "fail_in" => $fail_courses);
}
?>
<?php 
   function stackData($parent,$child){
        $result = array();
        try{
            if(is_array($parent) && is_array($child)){
                
                foreach($parent as $index => $parent_value){
                    foreach($parent_value as $parent_key => $parent_key_value){
                        foreach($child as $child_index => $child_value){
                            if($parent_key_value == $child_value[$parent_key] && array_key_exists($parent_key, $child_value)){
                                $result[$parent_key_value][] = $child_value;
                            }
                        } 
                    }  
                }
                return $result;
        }else
        {
          throw new Exception('first and second param should be of type array !');  
        }
        
        }
         catch (Exception $e){
            echo '<strong>Error Message !</strong>'.$e->getMessage();
            }
        }?>
